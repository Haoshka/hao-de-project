import requests
import csv
import os
from datetime import datetime

# === Settings ===
COIN = "solana"
VS_CURRENCY = "usd"
DAYS = 7  # Last 7 days
OUTPUT_CSV = "solana_ohlc.csv"  # This will be saved in the same directory as the script

# Get the current directory where the script is located
script_dir = os.path.dirname(os.path.abspath(__file__))
output_path = os.path.join(script_dir, OUTPUT_CSV)

# === Fetch data from CoinGecko ===
url = f"https://api.coingecko.com/api/v3/coins/{COIN}/ohlc"
params = {
    "vs_currency": VS_CURRENCY,
    "days": DAYS
}

print(f"Fetching OHLC data for {COIN} for the last {DAYS} days...")
response = requests.get(url, params=params)
response.raise_for_status()  # Raise error if bad response

data = response.json()

# === Write to CSV ===
print(f"Writing data to {output_path}...")

with open(output_path, mode="w", newline="") as file:
    writer = csv.writer(file)
    writer.writerow(["timestamp", "open", "high", "low", "close"])  # CSV header

    for entry in data:
        # Convert epoch milliseconds to 'YYYY-MM-DD HH:00:00' format
        timestamp = datetime.utcfromtimestamp(entry[0] / 1000).strftime('%Y-%m-%d %H:00:00')
        open_price, high_price, low_price, close_price = entry[1], entry[2], entry[3], entry[4]
        writer.writerow([timestamp, open_price, high_price, low_price, close_price])

print("Done!")
